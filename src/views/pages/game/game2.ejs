<div class="container-fluid px-0 game-container">
    <!-- Header da Partida -->
    <div class="game-header bg-gradient shadow-sm p-3 mb-4">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-4">
                    <div class="game-info">
                        <h5 class="mb-1"><i class="bi bi-controller"></i> Partida</h5>
                        <small class="text-muted">ID: <span id="partidaId">Carregando...</span></small>
                    </div>
                </div>
                <div class="col-md-4 text-center">
                    <div class="score-display">
                        <h3 class="mb-0 fw-bold text-primary">
                            <i class="bi bi-trophy-fill text-warning"></i>
                            <span id="scoreAtual">0</span>
                        </h3>
                        <small class="text-muted">Pontuação Atual</small>
                    </div>
                </div>
                <div class="col-md-4 text-end">
                    <div class="game-stats">
                        <div class="mb-1">
                            <i class="bi bi-arrow-repeat"></i> Rodadas: <strong id="numRodadas">0</strong>
                        </div>
                        <button class="btn btn-danger btn-sm" id="btnAbandonar">
                            <i class="bi bi-door-open"></i> Abandonar Partida
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Área do Jogo -->
    <div class="container">
        <div class="row">
            <!-- Painel Principal: Grafo -->
            <div class="col-lg-8">
                <div class="card shadow-sm card-custom mb-4">
                    <div class="card-header text-dark" style="background-color: var(--marrom_escuro);">
                        <h5 class="mb-0"><i class="bi bi-diagram-3"></i> Grafo da Fofoca</h5>
                    </div>
                    <div class="card-body p-4" id="grafoArea">
                        <div class="text-center py-5" id="grafoLoading">
                            <div class="spinner-border text-primary mb-3" role="status">
                                <span class="visually-hidden">Carregando...</span>
                            </div>
                            <p class="text-muted">Aguardando dados do grafo...</p>
                        </div>
                        <div id="grafoCanvas" class="d-none">
                            <!-- O grafo será renderizado aqui -->
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle"></i> Grafo será implementado em breve
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Painel Lateral: Controles e Info -->
            <div class="col-lg-4">
                <!-- Status da Sessão -->
                <div class="card shadow-sm card-custom mb-4">
                    <div class="card-header text-dark" style="background-color: var(--marrom_escuro);">
                        <h5 class="mb-0"><i class="bi bi-info-circle"></i> Status da Sessão</h5>
                    </div>
                    <div class="card-body">
                        <div id="sessionStatus">
                            <div class="d-flex align-items-center mb-3">
                                <div class="spinner-border spinner-border-sm text-primary me-2" role="status">
                                    <span class="visually-hidden">Carregando...</span>
                                </div>
                                <span class="text-muted">Conectando ao servidor...</span>
                            </div>
                        </div>
                        <div id="sessionInfo" class="d-none">
                            <div class="mb-3">
                                <strong>Status:</strong>
                                <span class="badge bg-success ms-2" id="statusBadge">Em Andamento</span>
                            </div>
                            <div class="mb-2">
                                <small class="text-muted">Sessão iniciada</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Scripts -->
<script>
let partidaAtual = null;
let intervaloPoll = null;

// Inicializa a página
async function initGame() {
    try {
        // Solicita ou retorna sessão existente
        const response = await fetch('/API/gameSection/join', {
            method: 'POST',
            credentials: 'same-origin',
            headers: { 'Content-Type': 'application/json' }
        });

        if (!response.ok) {
            throw new Error('Erro ao criar/obter sessão');
        }

        const data = await response.json();
        partidaAtual = data;

        // Carrega UI com dados da partida
        CarregaUI(data);
        
        // Mostra status de sucesso
        mostrarStatusConectado(data.isNew);

        // A IMPLEMENTAR GERAÇÂO DE GRAFO
        mostrarGrafo();

    } catch (err) {
        console.error('Erro ao inicializar jogo:', err);
        mostrarErroConexao();
    }
}

function CarregaUI(data) {
    document.getElementById('partidaId').textContent = data.id_partida || 'N/A';
    document.getElementById('scoreAtual').textContent = '0';
    document.getElementById('numRodadas').textContent = '0';
}

function mostrarStatusConectado(isNew) {
    const statusDiv = document.getElementById('sessionStatus');
    const infoDiv = document.getElementById('sessionInfo');
    
    statusDiv.innerHTML = `
        <div class="alert alert-success mb-0">
            <i class="bi bi-check-circle-fill"></i>
            ${isNew ? 'Nova partida criada!' : 'Partida retomada!'}
        </div>
    `;
    
    infoDiv.classList.remove('d-none');
}

function mostrarErroConexao() {
    const statusDiv = document.getElementById('sessionStatus');
    statusDiv.innerHTML = `
        <div class="alert alert-danger mb-0">
            <i class="bi bi-x-circle-fill"></i> Erro ao conectar
        </div>
        <button class="btn btn-primary btn-sm mt-2 w-100" onclick="initGame()">
            <i class="bi bi-arrow-clockwise"></i> Tentar Novamente
        </button>
    `;
}

function mostrarGrafo() {
    document.getElementById('grafoLoading').classList.add('d-none');
    document.getElementById('grafoCanvas').classList.remove('d-none');
}

// Abandonar partida
document.getElementById('btnAbandonar').addEventListener('click', async () => {
    if (!confirm('Tem certeza que deseja abandonar esta partida? Todo o progresso será perdido.')) {
        return;
    }

    try {
        const response = await fetch('/API/gameSection/leave', {
            method: 'POST',
            credentials: 'same-origin'
        });

        if (response.ok) {
            showNotification('Partida abandonada com sucesso!', 'success');
            setTimeout(() => {
                window.location.href = '/';
            }, 1500);
        } else {
            showNotification('Erro ao abandonar partida.', 'danger');
        }
    } catch (err) {
        console.error('Erro ao abandonar partida:', err);
        showNotification('Erro de conexão.', 'danger');
    }
});

// Notificações
function showNotification(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);';
    toast.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(toast);
    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 150);
    }, 4000);
}

// Inicializa ao carregar
document.addEventListener('DOMContentLoaded', initGame);
</script>
